<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compteur de Calorie en Ligne</title>
    <style>
        body {
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            color: #e0e0e0;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background: #1a1a1a;
            padding: 20px;
            text-align: center;
            font-size: 2em;
            color: #00bcd4;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .section {
            background: #333;
            padding: 20px;
            margin: 20px 0;
            display: none;
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .section.active {
            display: block;
        }
        label, input, select {
            display: block;
            margin: 10px 0;
            width: 100%;
        }
        input, select {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #444;
            color: #e0e0e0;
        }
        button {
            background: #00bcd4;
            border: none;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0097a7;
        }
        footer {
            background: #1a1a1a;
            text-align: center;
            padding: 10px;
            color: #00bcd4;
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.3);
        }
        canvas {
            width: 100% !important;
            max-width: 600px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #444;
            padding: 10px;
            text-align: center;
        }
        th {
            background: #444;
        }
        td button {
            background: #e91e63;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .message.success {
            background: #4caf50;
        }
        .message.error {
            background: #f44336;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
</head>
<body>
    <header>
        Compteur de Calorie en Ligne
    </header>
    <div class="container">
        <div id="auth" class="section active">
            <h2>Connexion ou Inscription</h2>
            <div id="loginForm">
                <h3>Connexion</h3>
                <label for="loginPseudo">Pseudo :</label>
                <input type="text" id="loginPseudo">
                <label for="loginPassword">Mot de passe :</label>
                <input type="password" id="loginPassword">
                <button onclick="login()">Se connecter</button>
                <div id="loginMessage" class="message"></div>
            </div>
            <div id="registerForm">
                <h3>Inscription</h3>
                <label for="registerEmail">Email :</label>
                <input type="email" id="registerEmail">
                <label for="registerPseudo">Pseudo :</label>
                <input type="text" id="registerPseudo">
                <label for="registerPassword">Mot de passe :</label>
                <input type="password" id="registerPassword">
                <button onclick="sendVerificationCode()">S'inscrire</button>
                <div id="registerMessage" class="message"></div>
                <div id="verificationForm" style="display: none;">
                    <label for="verificationCode">Code de vérification :</label>
                    <input type="text" id="verificationCode">
                    <button onclick="verifyCode()">Vérifier</button>
                    <div id="verificationMessage" class="message"></div>
                </div>
            </div>
        </div>
        <div id="menu" class="section">
            <h2>Menu Principal</h2>
            <button onclick="showSection('calcul')">Calculer les calories</button>
            <button onclick="showSection('graphique')">Voir l'évolution</button>
            <button onclick="logout()">Se déconnecter</button>
            <button onclick="supprimerCompte()">Supprimer mon compte</button>
        </div>
        <div id="calcul" class="section">
            <h2>Calcul des Calories</h2>
            <label for="regime">Choisissez votre régime :</label>
            <select id="regime">
                <option value="1">Prise de masse</option>
                <option value="2">Sèche</option>
                <option value="3">Maintenance</option>
            </select>
            <div id="surplusDeficit">
                <label id="labelSurplusDeficit" for="calories">De combien de calories voulez-vous être en <span id="surplusDeficitText">surplus</span> ?</label>
                <input type="number" id="calories">
            </div>
            <label for="caloriesBrulees">Combien de calories votre Apple Watch indique-t-elle que vous avez brûlées aujourd'hui ?</label>
            <input type="number" id="caloriesBrulees">
            <label>Avez-vous fait de la musculation aujourd'hui ?</label>
            <input type="radio" id="muscuOui" name="musculation" value="oui">
            <label for="muscuOui">Oui</label>
            <input type="radio" id="muscuNon" name="musculation" value="non" checked>
            <label for="muscuNon">Non</label>
            <div id="detailsMuscu" style="display: none;">
                <label for="caloriesMuscu">Combien de calories avez-vous brûlées pendant la séance de musculation ?</label>
                <input type="number" id="caloriesMuscu">
                <label for="dureeMuscu">Quelle était la durée de la séance de musculation en minutes ?</label>
                <input type="number" id="dureeMuscu">
                <label for="poids">Quel est votre poids (kg) ?</label>
                <input type="number" id="poids">
            </div>
            <button onclick="calculerCalories()">Calculer</button>
            <p id="resultat"></p>
        </div>
        <div id="graphique" class="section">
            <h2>Évolution des Données</h2>
            <canvas id="graphiqueCalories"></canvas>
            <canvas id="graphiquePoids"></canvas>
            <canvas id="graphiqueDuree"></canvas>
            <canvas id="graphiqueSurplusDeficit"></canvas>
            <table id="tableHistorique">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Calories Totales</th>
                        <th>Calories Brûlées</th>
                        <th>Calories Muscu</th>
                        <th>Durée Muscu</th>
                        <th>Poids</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button onclick="showSection('menu')">Retour au menu</button>
        </div>
    </div>
    <footer>
        &copy; 2024 Compteur de Calorie en Ligne - <a href="mailto:contact@caloriecompteur.com">Contactez-nous</a>
    </footer>
    <script>
        // Initialize EmailJS with your user ID
        emailjs.init("YOUR_EMAILJS_USER_ID");

        // Current user and data storage
        let currentUser = null;
        const users = JSON.parse(localStorage.getItem("users")) || [];

        // Show specific section
        function showSection(id) {
            document.querySelectorAll(".section").forEach(section => section.classList.remove("active"));
            document.getElementById(id).classList.add("active");
        }

        // Toggle details based on regime choice
        document.getElementById("regime").addEventListener("change", function () {
            const regime = this.value;
            const surplusDeficitText = regime === "1" ? "surplus" : "déficit";
            document.getElementById("surplusDeficitText").textContent = surplusDeficitText;
            document.getElementById("labelSurplusDeficit").textContent = `De combien de calories voulez-vous être en ${surplusDeficitText} ?`;
        });

        // Toggle musculation details
        document.querySelectorAll("input[name='musculation']").forEach(radio => {
            radio.addEventListener("change", function () {
                document.getElementById("detailsMuscu").style.display = this.value === "oui" ? "block" : "none";
            });
        });

        // Send verification code to email
        function sendVerificationCode() {
            const email = document.getElementById("registerEmail").value;
            if (!email) {
                document.getElementById("registerMessage").textContent = "Veuillez entrer une adresse email valide.";
                document.getElementById("registerMessage").classList.add("error");
                return;
            }
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            localStorage.setItem("verificationCode", code);
            emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
                to_email: email,
                verification_code: code
            }).then(response => {
                document.getElementById("registerMessage").textContent = "Code de vérification envoyé. Vérifiez votre email.";
                document.getElementById("registerMessage").classList.remove("error");
                document.getElementById("registerMessage").classList.add("success");
                document.getElementById("verificationForm").style.display = "block";
            }).catch(error => {
                document.getElementById("registerMessage").textContent = "Erreur lors de l'envoi du code de vérification.";
                document.getElementById("registerMessage").classList.add("error");
            });
        }

        // Verify the code
        function verifyCode() {
            const enteredCode = document.getElementById("verificationCode").value;
            const storedCode = localStorage.getItem("verificationCode");
            if (enteredCode === storedCode) {
                const email = document.getElementById("registerEmail").value;
                const pseudo = document.getElementById("registerPseudo").value;
                const password = document.getElementById("registerPassword").value;
                if (users.some(user => user.pseudo === pseudo)) {
                    document.getElementById("verificationMessage").textContent = "Pseudo déjà utilisé. Choisissez un autre pseudo.";
                    document.getElementById("verificationMessage").classList.add("error");
                    return;
                }
                users.push({ email, pseudo, password, history: [] });
                localStorage.setItem("users", JSON.stringify(users));
                document.getElementById("verificationMessage").textContent = "Inscription réussie. Vous pouvez maintenant vous connecter.";
                document.getElementById("verificationMessage").classList.remove("error");
                document.getElementById("verificationMessage").classList.add("success");
                document.getElementById("verificationForm").style.display = "none";
                document.getElementById("registerForm").reset();
            } else {
                document.getElementById("verificationMessage").textContent = "Code de vérification incorrect.";
                document.getElementById("verificationMessage").classList.add("error");
            }
        }

        // Login function
        function login() {
            const pseudo = document.getElementById("loginPseudo").value;
            const password = document.getElementById("loginPassword").value;
            const user = users.find(user => user.pseudo === pseudo && user.password === password);
            if (user) {
                currentUser = user;
                showSection("menu");
                document.getElementById("loginMessage").textContent = "";
                document.getElementById("loginForm").reset();
            } else {
                document.getElementById("loginMessage").textContent = "Pseudo ou mot de passe incorrect.";
                document.getElementById("loginMessage").classList.add("error");
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            showSection("auth");
        }

        // Delete account function
        function supprimerCompte() {
            if (currentUser) {
                const confirmation = confirm("Êtes-vous sûr de vouloir supprimer votre compte ?");
                if (confirmation) {
                    const index = users.findIndex(user => user.pseudo === currentUser.pseudo);
                    if (index > -1) {
                        users.splice(index, 1);
                        localStorage.setItem("users", JSON.stringify(users));
                        logout();
                        alert("Compte supprimé avec succès.");
                    } else {
                        alert("Erreur lors de la suppression du compte.");
                    }
                }
            }
        }

        // Calculate calories
        function calculerCalories() {
            const regime = document.getElementById("regime").value;
            const calories = parseInt(document.getElementById("calories").value);
            const caloriesBrulees = parseInt(document.getElementById("caloriesBrulees").value);
            const faitMuscu = document.querySelector("input[name='musculation']:checked").value === "oui";
            let caloriesMuscu = 0;
            let dureeMuscu = 0;
            let poids = 0;
            if (faitMuscu) {
                caloriesMuscu = parseInt(document.getElementById("caloriesMuscu").value);
                dureeMuscu = parseInt(document.getElementById("dureeMuscu").value);
                poids = parseInt(document.getElementById("poids").value);
            }
            const totalCalories = regime == "1" ? (caloriesBrulees + (faitMuscu ? caloriesMuscu : 0)) + calories : (caloriesBrulees + (faitMuscu ? caloriesMuscu : 0)) - calories;
            document.getElementById("resultat").textContent = `Votre apport calorique total pour aujourd'hui est de ${totalCalories} calories.`;

            // Save data to current user
            if (currentUser) {
                const today = new Date().toLocaleDateString();
                const record = {
                    date: today,
                    totalCalories,
                    caloriesBrulees,
                    caloriesMuscu: faitMuscu ? caloriesMuscu : 0,
                    dureeMuscu: faitMuscu ? dureeMuscu : 0,
                    poids: faitMuscu ? poids : 0
                };
                currentUser.history.push(record);
                localStorage.setItem("users", JSON.stringify(users));
                updateGraph();
                updateTable();
            }
        }

        // Update graph data
        function updateGraph() {
            if (!currentUser) return;

            const labels = currentUser.history.map(record => record.date);
            const totalCaloriesData = currentUser.history.map(record => record.totalCalories);
            const caloriesBruleesData = currentUser.history.map(record => record.caloriesBrulees);
            const caloriesMuscuData = currentUser.history.map(record => record.caloriesMuscu);
            const dureeMuscuData = currentUser.history.map(record => record.dureeMuscu);
            const poidsData = currentUser.history.map(record => record.poids);

            const ctxCalories = document.getElementById("graphiqueCalories").getContext("2d");
            new Chart(ctxCalories, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Calories Totales',
                            data: totalCaloriesData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'Calories Brûlées',
                            data: caloriesBruleesData,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const ctxMuscu = document.getElementById("graphiquePoids").getContext("2d");
            new Chart(ctxMuscu, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Poids',
                            data: poidsData,
                            borderColor: 'rgb(54, 162, 235)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const ctxDuree = document.getElementById("graphiqueDuree").getContext("2d");
            new Chart(ctxDuree, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Durée Muscu',
                            data: dureeMuscuData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update table data
        function updateTable() {
            if (!currentUser) return;

            const tbody = document.getElementById("historiqueTableBody");
            tbody.innerHTML = '';

            currentUser.history.forEach(record => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.totalCalories}</td>
                    <td>${record.caloriesBrulees}</td>
                    <td>${record.caloriesMuscu}</td>
                    <td>${record.dureeMuscu}</td>
                    <td>${record.poids}</td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
